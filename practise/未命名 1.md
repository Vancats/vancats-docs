---
date created: 2022-04-27 10:04
date updated: 2022-04-27 10:18
---

当我们调用 `del` 或者 `set` 方法的是，会通知更新 `ob.dep.notify()`

接下来的几个步骤就是更新内容，关键点在于

```js
this.deps = []
this.newDeps = []
this.depIds = new Set()
this.newDepIds = new Set()
```

这是 `Watcher` 中存的新旧 `deps`，在我们更新内容的时候，做的操作都是在新 `deps` 上操作

```js
addDep (dep: Dep) {
  const id = dep.id
  if (!this.newDepIds.has(id)) {
    this.newDepIds.add(id)
    this.newDeps.push(dep)
    if (!this.depIds.has(id)) {
      dep.addSub(this)
    }
  }
}
```

所以，在我们的 `updateComponent` 更新完成之后，我们是会根据以上情况获得一份新的 deps

```js
get() {
  try {
	// getter 就是 updateComponent
    value = this.getter.call(vm, vm)
  } catch (e) {
	...
  } finally {
    this.cleanupDeps()
  }
  return value
}
```

然后会执行 cleanupDeps，这里就不用多说了叭，对比删除，新老替换

```js
cleanupDeps() {
  let i = this.deps.length
  while (i--) {
    const dep = this.deps[i]
    if (!this.newDepIds.has(dep.id)) {
      dep.removeSub(this)
    }
  }
  let tmp = this.depIds
  this.depIds = this.newDepIds
  this.newDepIds = tmp
  this.newDepIds.clear()
  tmp = this.deps
  this.deps = this.newDeps
  this.newDeps = tmp
  this.newDeps.length = 0
}
```

<https://assets.leetcode.com/uploads/2021/06/08/waterflow-grid.jpg>
